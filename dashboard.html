<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>SISAR — Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Bootstrap / Icons / Estilos -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link href="assets/css/style.css" rel="stylesheet">
</head>
<body>
  <!-- Sidebar -->
  <nav class="sidebar">
    <a class="brand d-flex align-items-center mb-3 text-decoration-none" href="#">
      <i class="fa-solid fa-location-dot me-2"></i> SISAR
    </a>
    <ul class="nav nav-pills flex-column mb-auto">
      <!-- Dashboard: todos los roles -->
      <li class="nav-item">
        <a href="dashboard.html" class="nav-link active"
           data-roles="admin,coordinador,clinico,conductor,analista">
          <i class="fa-solid fa-chart-line me-2"></i>Dashboard
        </a>
      </li>

      <!-- Rutas: admin, coordinador -->
      <li>
        <a href="#" class="nav-link"
           data-roles="admin,coordinador">
          <i class="fa-solid fa-route me-2"></i>Rutas
        </a>
      </li>

      <!-- Pacientes: admin, coordinador, clinico, analista -->
      <li>
        <a href="pacientes.html" class="nav-link"
           data-roles="admin,coordinador,clinico,analista">
          <i class="fa-solid fa-user-injured me-2"></i>Pacientes
        </a>
      </li>

      <!-- Agenda: todos los roles -->
      <li>
        <a href="#" class="nav-link"
           data-roles="admin,coordinador,clinico,conductor,analista">
          <i class="fa-solid fa-calendar-check me-2"></i>Agenda
        </a>
      </li>

      <!-- Reportes: admin, coordinador, analista -->
      <li>
        <a href="#" class="nav-link"
           data-roles="admin,coordinador,analista">
          <i class="fa-solid fa-chart-column me-2"></i>Reportes
        </a>
      </li>

      <!-- Configuración: solo admin -->
      <li>
        <a href="#" class="nav-link"
           data-roles="admin">
          <i class="fa-solid fa-gear me-2"></i>Configuración
        </a>
      </li>
    </ul>
    <hr class="text-secondary">
    <div class="small text-secondary">© SISAR MPV</div>
  </nav>

  <!-- Contenido principal -->
  <div class="content">
    <!-- Topbar -->
    <div class="topbar py-2 px-3 d-flex align-items-center">
      <div class="ms-auto d-flex align-items-center gap-2">
        <span id="userInfo" class="text-muted small">—</span>
        <button class="btn btn-sm btn-outline-secondary" id="btnSync">
          <i class="fa-solid fa-arrows-rotate me-1"></i>Sync
        </button>
        <button class="btn btn-sm btn-primary" id="btnLogout">
          <i class="fa-solid fa-right-from-bracket me-1"></i>Salir
        </button>
      </div>
    </div>

    <main class="pt-3">
      <!-- KPIs -->
      <div class="row g-3">
        <div class="col-sm-6 col-lg-3">
          <div class="card card-soft kpi">
            <div class="card-body d-flex align-items-center">
              <div class="icon bg-primary-subtle text-primary"><i class="fa-solid fa-route"></i></div>
              <div class="ms-3">
                <div class="value" id="kpiRutas">0</div>
                <div class="label">Rutas recorridas</div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="card card-soft kpi">
            <div class="card-body d-flex align-items-center">
              <div class="icon bg-success-subtle text-success"><i class="fa-solid fa-stethoscope"></i></div>
              <div class="ms-3">
                <div class="value" id="kpiAtenciones">0</div>
                <div class="label">Atenciones realizadas</div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="card card-soft kpi">
            <div class="card-body d-flex align-items-center">
              <div class="icon bg-info-subtle text-info"><i class="fa-solid fa-users"></i></div>
              <div class="ms-3">
                <div class="value" id="kpiPacientes">0</div>
                <div class="label">Lista de Pacientes</div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="card card-soft kpi">
            <div class="card-body d-flex align-items-center">
              <div class="icon bg-warning-subtle text-warning"><i class="fa-solid fa-bell"></i></div>
              <div class="ms-3">
                <div class="value" id="kpiAlertas">0</div>
                <div class="label">Reportes / Notificaciones</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="row g-3 mt-1">
        <div class="col-lg-8">
          <div class="card card-soft">
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <h6 class="mb-0">Grafico Estadistico de Prueba</h6>
                <div class="ms-auto small text-muted">Semana</div>
              </div>
              <canvas id="chartRevenue" height="120"></canvas>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card card-soft h-100">
            <div class="card-body">
              <h6 class="mb-2">Informacion Util</h6>
              <div class="d-flex align-items-center gap-2">
                <span class="badge bg-primary-subtle text-primary badge-pill">+14%</span>
                <small class="text-muted">vs. semana anterior</small>
              </div>
              <div class="mt-3 text-muted small">Panel de informacion de Georeferencia</div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Librerías -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Módulos del proyecto -->
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/dashboard.js"></script>
  <script src="assets/js/storage.js"></script>


  <script>
    // ===== Guard de sesión =====
    const me = currentUser();
    if (!me) { location.href = 'login.html'; }

    // Mostrar usuario y rol en topbar
    document.getElementById('userInfo').textContent = `${me.nombre} — ${me.role}`;

    // Eventos de topbar
    document.getElementById('btnLogout').addEventListener('click', logout);
    //document.getElementById('btnSync').addEventListener('click', () => alert('Sincronización simulada OK'));
    document.getElementById('btnSync').addEventListener('click', ()=>{const n = syncPendientes();alert(n ? `Sincronizadas ${n} atenciones pendientes.` : 'No hay atenciones pendientes.');
  });

    // ===== Filtrado de menú por rol =====
    // Cada link del sidebar puede declarar data-roles="admin,coordinador,..."
    document.querySelectorAll('.sidebar a.nav-link[data-roles]').forEach(link => {
      const allowed = link.dataset.roles.split(',').map(s => s.trim());
      if (!allowed.includes(me.role)) {
        link.style.display = 'none';
      }
    });

    // ===== KPIs y gráfico =====
    setKPIs();
    renderCharts();
  </script>
</body>
</html>